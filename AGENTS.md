Autopolit v2 — AGENTS.md
Назначение проекта

Autopolit v2 — это система для автоматической работы с PDF-сметами и документами. Основная задача — безопасно конвертировать PDF в изображения WebP (lossless), с кэшем по содержимому и защитными мерами (водяные знаки), чтобы минимизировать риск копирования или несанкционированного использования клиентами.
Система интегрируется с Telegram-ботами и может автоматически отправлять рендеры в каналы/чаты.

Основные возможности

Рендер PDF → WebP

Используется mutool (MuPDF) для быстрой отрисовки.

Сразу сохраняем в WebP (без промежуточного PNG).

Поддержка lossless для качества как у PDF.

Кэширование по контент-хэшу

SHA256 от файла PDF.

Если рендер уже делался → сразу отдаём результат.

Распараллеливание страниц

Рендер каждой страницы запускается отдельно (асинхронно).

При больших PDF рендер идёт быстрее.

Водяные знаки

При создании клиента указывается watermark_text.

Текст ограничен по длине (чтобы был читаемым).

Встраивается в каждую страницу PDF при рендере, полупрозрачный, не мешает просмотру.

Пример: «Итоговая стоимость 325850р».

API

/healthz — проверка состояния (API и DB).

/clients — создание клиентов с именем и водяным знаком.

/upload — загрузка PDF (с client_id). Возвращает job_id.

/job/{id} — статус выполнения (queued, processing, done, error).

/files/{filename} — отдача готовых WebP-страниц.

Интеграция с Telegram

Бот автоматически загружает PDF, получает рендер, отправляет в канал.

Защита от пересылки/копирования (в будущем: настройки прав в чате).

Архитектура

API (FastAPI)
Принимает загрузки, управляет клиентами, хранит статус задач.

Worker
Берёт задания из Redis, выполняет рендер PDF→WebP, накладывает водяные знаки.

Postgres
Хранит список клиентов и настройки (например watermark).

Redis
Очередь заданий для worker.

Bot / Userbot
Telegram-интеграция для общения с клиентами и выгрузки файлов.

Что уже сделано

Миграции clients и watermark_text.

FastAPI API (/clients, /upload, /job, /files, /healthz).

Worker с кэшем по хэшу PDF.

Рендер напрямую в WebP (lossless).

Проверка работоспособности через PowerShell скрипты (scripts/http.ps1, scripts/upload.ps1).

CI пока нет, но структура репозитория готова для GitHub Actions.

Что планируется

Улучшение watermark (расположение по сетке, полупрозрачность, выбор шрифта).

Гибкие флаги для MuPDF (ускорение рендера: сглаживание, downscale).

Управление правами при публикации файлов в Telegram.

Автодеплой через GitHub Actions.

Добавление AGENTS.md в CI, чтобы всегда оставался актуальным.

Взаимодействие с ассистентом (ChatGPT/Codex)

Чтобы работа шла без лишних итераций:

Когда нужны патчи

Я выдаю готовые .diff файлы, которые можно применять через git apply.

Патчи всегда складывать в папку patches/.

Когда нужен файл

Я отдаю содержимое целиком (готовый к копипасту).

Ты просто открываешь файл и заменяешь содержимое.

Когда нужны команды

Я даю их блоками (готовыми под PowerShell).

Ты копируешь и вставляешь в терминал.

Если есть ошибки

Показывай полные логи (желательно docker compose logs --tail=200 ...).

Я анализирую и предлагаю фикс.

Git-флоу

Работаем через feature-ветки.

После проверок → PR → merge в main.

Итог

Autopolit v2 — это не просто конвертер PDF → WebP.
Это полный пайплайн для автоматизации смет, с безопасной доставкой до клиента и встроенной защитой от копирования.
Проект активно развивается: сейчас сделаны основные кирпичики (рендер, кэш, API, watermark), дальше будет оптимизация скорости и интеграция с Telegram.