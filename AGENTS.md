# Autopolit v2 вЂ” AGENTS.md

РљСЂР°С‚РєРёР№ Р±СЂРёС„ РґР»СЏ РєРѕРґ-Р°РіРµРЅС‚РѕРІ (OpenAI Codex / вЂњРР-РїРµР№СЂвЂќ) РїРѕ РїСЂРѕРµРєС‚Сѓ.

## 1) РќР°Р·РЅР°С‡РµРЅРёРµ
- РЎРµСЂРІРёСЃ РїСЂРёРЅРёРјР°РµС‚ PDF СЃРјРµС‚С‹ в†’ СЂРµРЅРґРµСЂРёС‚ **СЃС‚СЂР°РЅРёС†Сѓ(С‹) РІ WebP (lossless)** c РІРѕРґСЏРЅС‹Рј Р·РЅР°РєРѕРј.
- Р¦РµР»СЊ: Р±С‹СЃС‚СЂРѕ (в‰¤30 c), Р±РµР· СѓС‚РµС‡РєРё РєРѕРЅС‚РµРЅС‚Р° (РјРёРЅРёРјРёР·Р°С†РёСЏ РєРѕРїРёСЂРѕРІР°РЅРёСЏ/СЃРєСЂРёРЅС€РѕС‚Р°).

## 2) РўРµРєСѓС‰Р°СЏ Р°СЂС…РёС‚РµРєС‚СѓСЂР°
- **api/** (FastAPI): РєРѕРЅРµС‡РЅС‹Рµ С‚РѕС‡РєРё `/healthz`, `/clients`, `/upload`, `/job/{id}`, `/files/*`.
- **worker/** (Uvicorn): РїРѕРґРїРёСЃС‡РёРє РѕС‡РµСЂРµРґРё (Redis), СЂРµР°Р»СЊРЅРѕ СЂРµРЅРґРµСЂРёС‚ PDF в†’ WebP.
- **bot/**, **userbot/**: С‚РµР»РµРіСЂР°Рј-РёРЅС‚РµРіСЂР°С†РёРё (РЅРµ РєСЂРёС‚РёС‡РЅРѕ РІ СЌС‚РѕРј РїР°С‚С‡Рµ).
- **postgres**, **redis** вЂ” РёРЅС„СЂР°СЃС‚СЂСѓРєС‚СѓСЂР°.

## 3) Р§С‚Рѕ РґРµР»Р°РµС‚ СЌС‚РѕС‚ Р°РїРґРµР№С‚
1. Р РµРЅРґРµСЂ: **mutool draw в†’ PNG в†’ cwebp (lossless)**, Р±РµР· Pillow РІ РіРѕСЂСЏС‡РµРј РїСѓС‚Рё.
2. **РљСЌС€**: РїРѕ SHA-256 СЃРѕРґРµСЂР¶РёРјРѕРіРѕ PDF (`/data/cache/<hash>/page-<n>.webp`).
3. **Р Р°СЃРїР°СЂР°Р»Р»РµР»РёРІР°РЅРёРµ**: РїРѕ СЃС‚СЂР°РЅРёС†Р°Рј (ENV `WORKER_MAX_PROCS`, `MUTOOL_DPI`).
4. **Р’Р°С‚РµСЂРјР°СЂРєР°**: С‚РµРєСЃС‚ РёР· `clients.watermark_text` (С‡РµСЂРµР· API `client_id`).
5. Р”РѕРє: СЌС‚РѕС‚ `AGENTS.md`.

## 4) РћРєСЂСѓР¶РµРЅРёРµ (ENV)
- `RENDER_TIMEOUT_SEC` (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ 60вЂ“120): РѕР±С‰РёР№ С‚Р°Р№РјР°СѓС‚ РЅР° Р·Р°РґР°С‡Сѓ.
- `MUTOOL_DPI` (РЅР°РїСЂРёРјРµСЂ 150вЂ“300): DPI СЂРµРЅРґРµСЂР° mutool.
- `WORKER_MAX_PROCS` (РЅР°РїСЂРёРјРµСЂ 2вЂ“4): СЃРєРѕР»СЊРєРѕ РїСЂРѕС†РµСЃСЃРѕРІ РїР°СЂР°Р»Р»РµР»РёС‚СЊ СЃС‚СЂР°РЅРёС†С‹.
- `RENDER_LOSSLESS` (1/0): lossless WebP.

## 5) РџСЂРѕРІРµСЂРєР° (Р»РѕРєР°Р»СЊРЅРѕ)
1. `docker compose up -d --build api worker`
2. `POST /clients` в†’ РїРѕР»СѓС‡РёС‚СЊ `id`
3. `POST /upload (file, client_id)` в†’ РїРѕР»СѓС‡РёС‚СЊ `job_id`
4. РџРѕР»Р»РёРЅРі `GET /job/{job_id}` РґРѕ `done` в†’ РїРѕР»СѓС‡Р°РµРј `url` WebP

## 6) РџСЂРѕРёР·РІРѕРґРёС‚РµР»СЊРЅРѕСЃС‚СЊ
- РўС‘РїР»С‹Р№ РєСЌС€: РІС‹РґР°С‡Р° РјРіРЅРѕРІРµРЅРЅРѕ (С„Р°Р№Р»С‹ СѓР¶Рµ Р»РµР¶Р°С‚ РІ `/data/cache/<hash>`).
- РҐРѕР»РѕРґРЅС‹Р№: РІС‹РґР°С‘Рј 1-СЋ СЃС‚СЂР°РЅРёС†Сѓ СЃСЂР°Р·Сѓ РїРѕСЃР»Рµ РіРѕС‚РѕРІРЅРѕСЃС‚Рё, Р±РµР· Pillow РІ СЂРµРЅРґРµСЂРµ.

## 7) Р‘РµР·РѕРїР°СЃРЅРѕСЃС‚СЊ
- Р’РѕРґСЏРЅРѕР№ Р·РЅР°Рє РЅР° СЃС‚РѕСЂРѕРЅРµ worker РїСЂРё СЃР±РѕСЂРєРµ WebP.
- РЎС‹СЂС‹Рµ PNG СѓРґР°Р»СЏСЋС‚СЃСЏ РїРѕСЃР»Рµ СѓРїР°РєРѕРІРєРё.